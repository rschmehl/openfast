# MoorDyn Module
This is an externally developed module with further information
available on the developer's documentation site:
[Matt Hall](http://www.matt-hall.ca/moordyn.html).

The legacy version of FAST's information regarding this module
are available at the [NWTC Software Portal](https://nwtc.nrel.gov/MoorDyn/).

## Overview
MoorDyn is a lumped-mass mooring line model for simulating the dynamics of
moorings connected to floating offshore structures. It accounts for internal
axial stiffness and damping forces, weight and buoyancy forces, hydrodynamic
forces from Morison's equation (assuming quiescent water so far), and vertical
spring-damper forces from contact with the seabed. MoorDyn's input file format
is based on that of MAP. The model supports arbitrary line interconnections,
clump weights and floats, and different line properties.

The Fortran implementation of MoorDyn, which has been developed
following the FAST Modularization Framework, is included as a module in
OpenFAST.

For the C++ implementation of MoorDyn, see http://www.matt-hall.ca/moordyn.
"MoorDyn C" can be compiled as a dynamically-linked library and features
simpler functions for easy coupling with models or scripts coded in C/C++,
Fortran, Matlab/Simulink, etc. It has recently been integrated into WEC-Sim.

Both forms of MoorDyn feature the same underlying mooring model, use similar
input and output conventions, and are being updated and improved in parallel.
They follow the same version numbering, with a "C" or "F" suffix for
differentiation.

---

# Python Integration

## Objective

The objective is to easily provide a C-based interface for the input and
output data for each module. The interface should consist of:

- C-compatible function call to routines for initialization
- C-compatible function call to routines for getting output
- C-compatible data type definitions

The C-compatible Fortran code can be autogenerated based on the existing
API's for module initialization and output. The Fortran derived types
are currently autogenerated through the OpenFAST Registry. Given an
additional flag (`-ccode`), the Registry will also generate C-compatible
Fortran types and a header file for use in C code.

## Method

The protoype driver program is a Python driver for MoorDyn,
`MoorDyn_Driver.py`. The C-compatible output of the OpenFAST Registry
for the MoorDyn Types module, `MoorDyn_Types_C.f90`, was slightly
modified since some existing components would not compile. The
included subroutines for packing and unpacking the C-compatible types
were also removed. Using the

[ctypeslib](https://github.com/trolldbois/ctypeslib) Python module, the
header file from the Registry, `MoorDyn_Type.h`, was converted to a
starting point for the Python types, `MoorDyn_Types.py`.

An additional class was added to the basic Python types to provide a mechanism
for autogenerating Fortran code to move C-based field to Fortran-based fields
within a derived type:

```python
class BaseOpenFASTType():
    def export_f2c(self):
        print( f"! {type(self).__name__} - Fortran to C" )
        for field in self._fields_:
            if "PADDING" in field[0]:
                continue
            print(f"{self._openfast_name}_C%{field[0]} = {self._openfast_name}%{field[0]}")

    def export_c2f(self):
        print( f"! {type(self).__name__} - C to Fortran" )
        for field in self._fields_:
            if "PADDING" in field[0]:
                continue
            print(f"{self._openfast_name}%{field[0]} = {self._openfast_name}_C%{field[0]}")
    
    def export_conversions(self):
        self.export_c2f()
        self.export_f2c()
```

As implemented, this pipeline for data flow supports scalar values well, but
array values are not supported. The prototype infrastructure for handling
arrays is implemented in a simpler project at https://github.com/rafmudaf/sqrt.

**NOTE: It is important to remember that the fields in the Python types must
be listed in the same order as the attributes in the Fortran types. Basically,
the way its listed in Fortran is the way it will be used, and Python type
definition simply maps locations in memory to a name in the object.**

## Generating the interface and types

The Fortran code and accompanying Python code that define the interface
should be easily generated given the existing code in OpenFAST. This tool
should take as input:

- The main module file where the initialization routines are specified
- The module's OpenFAST Registry input file: `<module>_Registry.txt`

It should generate:

- A working Fortran module containing the C-compatible derived types
- A Python module defining the drived types
- A Fortran module defining the wrapper interface which will handle
  passing data between the C-based and Fortran types as well as
  making the actual function call
- A Python module listing the OpenFAST calls available and populating
  the argument types and return type for each

Summary: Given `MoorDyn_Registry.txt` and  `MoorDyn.f90`, we should be able to
run a command (i.e. `python generate_openfast_c_interface.py MoorDyn`) and
have as output `MoorDyn_Types.py`, `MoorDyn_Types_C.f90`, and `MoorDyn_C.f90`.
